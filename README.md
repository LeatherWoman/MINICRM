# CRM Lead Distribution System
Мини-CRM система для автоматического распределения лидов между операторами по источникам с учетом весов и лимитов нагрузки.

## Возможности
* Управление операторами: CRUD операции, настройка лимитов нагрузки, управление активностью

* Управление источниками: Создание ботов/источников, настройка распределения

* Автоматическое распределение: Интеллектуальное распределение лидов с учетом весов операторов

* Учет нагрузки: Контроль лимитов нагрузки операторов в реальном времени

* Идентификация лидов: Автоматическое определение и создание лидов по внешним идентификаторам

* Мониторинг: Просмотр статистики и распределения обращений

* Полное тестирование: Unit и интеграционные тесты с покрытием


## Быстрый старт
### Способ 1: Локальный запуск

git clone <https://github.com/LeatherWoman/MINICRM>
cd src
uv run uvicorn main:app --host 0.0.0.0 --port 8000 --reload

### Способ 2: Запуск с Docker

docker-compose up --build


## API документация
После запуска сервера доступны:

Swagger UI: http://localhost:8000/docs

ReDoc: http://localhost:8000/redoc

Health check: http://localhost:8000/health

## Модель данных
### Основные сущности:
1. Operator (Оператор)

    * id - уникальный идентификатор

    * name - имя оператора

    * email - email (уникальный)

    * is_active - активен/неактивен

    * max_load - максимальная нагрузка (лимит)

    * current_load - текущая нагрузка (вычисляемое поле)

2. Lead (Лид)

    * id - уникальный идентификатор

    * external_id - внешний идентификатор (уникальный)

    * phone, email, full_name - контактные данные

    * notes - дополнительные заметки

3. Source (Источник)

    * id - уникальный идентификатор

    * name - название источника

    * bot_token - токен бота (уникальный)

    * description - описание

4. SourceWeight (Вес оператора)

    * source_id - ID источника

    * operator_id - ID оператора

    * weight - вес для распределения (целое число)

5. Contact (Контакт/Обращение)

    * id - уникальный идентификатор

    * lead_id - ID лида

    * source_id - ID источника

    * operator_id - ID оператора (может быть NULL)

    * message - текст обращения

    * status - статус (new, in_progress, closed)

    * is_active - активно/неактивно

### Связи:
* Один Lead → много Contact

* Один Source → много Contact

* Один Operator → много Contact

* Source и Operator связаны через SourceWeight (многие-ко-многим)

## Алгоритм распределения
### Процесс создания обращения:
1. Идентификация лида

    * Поиск лида по external_id

    * Если не найден - создание нового лида

    * Обновление контактных данных при необходимости

2. Определение доступных операторов

    * Получение операторов, назначенных на источник

    * Фильтрация по:

        ** Активность оператора (is_active = True)

        ** Нагрузка не превышает лимит (current_load < max_load)

3. Распределение по весам

    * Вероятностный выбор оператора

    * Вероятность = вес_оператора / сумма_весов

    * Пример: вес 70 и 30 → 70% и 30% трафика соответственно

4. Создание обращения

    * Связывание с лидом, источником и оператором

    * Если нет доступных операторов → создание без оператора

### Ключевые особенности:
* Лимиты нагрузки: Оператор не получает новые обращения при достижении лимита

* Вероятностное распределение: Обеспечивает соблюдение заданных пропорций в долгосрочной перспективе

* Отказоустойчивость: Обращения создаются даже без доступных операторов

## API Endpoints
### Операторы (`/api/v1/operators/`)
* `POST /` - создание оператора

* `GET /` - список операторов

* `GET /available` - доступные операторы (с нагрузкой)

* `GET /{id}` - оператор по ID

* `PUT /{id}` - обновление оператора

* `DELETE /{id}` - удаление оператора

### Источники (`/api/v1/sources/`)
* `POST /` - создание источника

* `GET /` - список источников

* `GET /{id}` - источник с весами

* `POST /{id}/weights` - добавление веса оператора

* `DELETE /{id}/weights/{operator_id}` - удаление веса

### Лиды (`/api/v1/leads/`)
* `POST /` - создание лида

* `GET /` - список лидов

* `GET /{id}` - лид по ID

* `PUT /{id}` - обновление лида

### Контакты (`/api/v1/contacts/`)
* `POST /` - создание обращения (автоматическое распределение)

* `GET /` - все обращения с деталями

* `GET /by-lead/{lead_id}` - обращения лида

* `GET /by-operator/{operator_id}` - обращения оператора

* `PUT /{id}/close` - закрытие обращения


## Тестирование

uv run python -m pytest tests/ -v -s

## Примеры использования
### Сценарий 1: Настройка системы
```bash
# 1. Создаем операторов
curl -X POST "http://localhost:8000/api/v1/operators/" \
  -H "Content-Type: application/json" \
  -d '{"name": "Иван Иванов", "email": "ivan@example.com", "max_load": 10}'

curl -X POST "http://localhost:8000/api/v1/operators/" \
  -H "Content-Type: application/json" \
  -d '{"name": "Мария Петрова", "email": "maria@example.com", "max_load": 15}'

# 2. Создаем источник
curl -X POST "http://localhost:8000/api/v1/sources/" \
  -H "Content-Type: application/json" \
  -d '{"name": "Telegram Bot", "bot_token": "tg_bot_123"}'

# 3. Настраиваем распределение (70% Ивану, 30% Марии)
curl -X POST "http://localhost:8000/api/v1/sources/1/weights" \
  -H "Content-Type: application/json" \
  -d '{"operator_id": 1, "weight": 70}'

curl -X POST "http://localhost:8000/api/v1/sources/1/weights" \
  -H "Content-Type: application/json" \
  -d '{"operator_id": 2, "weight": 30}'
```
### Сценарий 2: Обработка обращения
```bash
# Клиент пишет в бот
curl -X POST "http://localhost:8000/api/v1/contacts/" \
  -H "Content-Type: application/json" \
  -d '{
    "lead_external_id": "client_123",
    "source_id": 1,
    "message": "Здравствуйте, нужна консультация",
    "phone": "+79161234567",
    "full_name": "Алексей Смирнов"
  }'

# Ответ: {"id": 1, "lead_id": 1, "operator_id": 1, ...}
# Оператор назначен автоматически с учетом весов и нагрузки
```
### Сценарий 3: Мониторинг
```bash
# Текущая нагрузка операторов
curl "http://localhost:8000/api/v1/operators/available"

# Все обращения
curl "http://localhost:8000/api/v1/contacts/"

# Обращения конкретного лида
curl "http://localhost:8000/api/v1/contacts/by-lead/1"
```

## Руководство по стилю кода
```bash
# Проверка стиля
uv run ruff check --fix .

# Автоформатирование
uv run ruff format .  
```
